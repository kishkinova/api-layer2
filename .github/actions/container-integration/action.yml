name: 'Run Integration Tests'
description: 'Run Integration Tests against services started as service containers.'
inputs:
    gradle_task_name:
        description: 'Name of the task to run'
        required: true
        default: ':integration-tests:runContainerTests'
    integration_tests_config:
        description: 'the last part of the environment-configuration file e.g. -attls, -docker, ...'
        required: true
        default: ''
    artifacts_name:
        description: 'The name under which will be the results stored. '
        required: true
        default: 'IT-Tests'

runs:
    using: "composite"
    steps:
        -   name: Set up JDK 1.8
            uses: actions/setup-java@v1
            with:
                java-version: 1.8
        -   name: Grant execute permission for gradlew
            run: chmod +x gradlew
        -   name: Cache Gradle packages
            uses: actions/cache@v2
            with:
                path: |
                    ~/.gradle/caches
                    ~/.gradle/wrapper
                key: ${{ runner.os }}-gradle001-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                restore-keys: |
                    ${{ runner.os }}-gradle001-
        -   name: Cache Node.js modules
            uses: actions/cache@v2
            with:
                path: |
                    ~/.npm
                key: ${{ runner.OS }}-node001-${{ hashFiles('**/package-lock.json, **/package.json') }}
                restore-keys: |
                    ${{ runner.OS }}-node001-
        -   name: Run CI Tests
            run: >
                ./gradlew ${{ inputs.gradle_task_name }} --info -Denvironment.config=${{ inputs.integration_tests_config }} -Denvironment.offPlatform=true
                -Partifactory_user=${{ secrets.ARTIFACTORY_USERNAME }} -Partifactory_password=${{ secrets.ARTIFACTORY_PASSWORD }}
        -   name: Store results
            uses: actions/upload-artifact@v2
            if: always()
            with:
                name: ${{ inputs.artifacts_name }}
                path: |
                    integration-tests/build/reports/**
        -   name: Cleanup Gradle Cache
            run: |
                rm -f ~/.gradle/caches/modules-2/modules-2.lock
                rm -f ~/.gradle/caches/modules-2/gc.properties
                rm -rf ~/.gradle/caches/build-cache-1
